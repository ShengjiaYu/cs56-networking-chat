<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Client.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cs56-networking-chat</a> &gt; <a href="index.source.html" class="el_package">client.model</a> &gt; <span class="el_source">Client.java</span></div><h1>Client.java</h1><pre class="source lang-java linenums">package client.model;

import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.net.Socket;
import java.net.SocketException;
import java.util.ArrayList;


import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.DataLine;
import javax.sound.sampled.LineUnavailableException;
import javax.sound.sampled.SourceDataLine;


import client.controller.ClientController;

/**
 * Represents a client who can connect/disconnect to the server 
 * and chat with other people on the server  
 * @author Peng Wang, Andro Stotts, Bryce Filler, Max Hinson
 * @version 0.4
 */
public class Client {
    private static Client client;
    private ClientController controller;
<span class="fc" id="L30">    private int portNumber = 8888;</span>

    private String userName;
    private String nickName;
    private String serverIP;
    private String clientIP;
    private ArrayList&lt;Contact&gt; contacts;
    private Socket mySocket;

    private DataOutputStream dos;
    private DataInputStream dis;

    private boolean isConnected;

<span class="fc" id="L44">    private boolean soundOn = true;</span>

    
    /**
     * Initialize instance variables
     */
<span class="fc" id="L50">    private Client(){</span>
<span class="fc" id="L51">	userName = &quot;&quot;;</span>
<span class="fc" id="L52">	nickName = &quot;&quot;;</span>
<span class="fc" id="L53">	serverIP = &quot;&quot;;</span>
<span class="fc" id="L54">	clientIP = &quot;&quot;;</span>
<span class="fc" id="L55">	mySocket = null;</span>
<span class="fc" id="L56">	dos = null;</span>
<span class="fc" id="L57">	dis = null;</span>
<span class="fc" id="L58">	isConnected = false;</span>
<span class="fc" id="L59">	contacts = new ArrayList&lt;Contact&gt;();</span>
<span class="fc" id="L60">    }</span>
	
    /**
     * getClient method is used for get a client object
     * @return instance of Client
     */
    public static Client getClient(){
<span class="fc bfc" id="L67" title="All 2 branches covered.">	if(client == null)</span>
<span class="fc" id="L68">	    client = new Client();</span>
<span class="fc" id="L69">	return client;</span>
    }

    /**
     * setuserName method is used for setting user's userName
     * @param userName the user's userName
     */
    public void setUserName(String userName){
<span class="fc" id="L77">	this.userName = userName;</span>
<span class="fc" id="L78">    }</span>

    /**

     * setnickName method is used for setting user's nickName
     * @param nickName the user's nickName
     */
    public void setNickname(String nickName){
<span class="fc" id="L86">	this.nickName = nickName;</span>
<span class="fc" id="L87">    }</span>
	
	
    /**
     * getuserName method is used for getting the user's userName of a Client object
     * @return userName the user's userName
     */
    public String getUserName(){
<span class="fc" id="L95">	return userName;</span>
    }

    /**
     * getnickName method is used for getting the user's nickName of a Client object
     * @return nickName the user's nickName
     */
    public String getNickname(){
<span class="fc" id="L103">	return nickName;</span>
    }

	
    /**
     * setServerIP method is used for setting the IP address which the client is connecting 
     * @param serverIP the IP address of the server
     */
    public void setServerIP(String serverIP){
<span class="fc" id="L112">	this.serverIP = serverIP;</span>
<span class="fc" id="L113">    }</span>
	
    /**
     * getServerIP returns the server IP address which the client is connecting
     * @return the server's IP address
     */
    public String getServerIP(){
<span class="fc" id="L120">	return serverIP;</span>
    }
	
    /**
     * setClientIP is used for setting up 
     * @param clientIP the IP address of the client
     */
    public void setClientIP(String clientIP){
<span class="fc" id="L128">	this.clientIP = clientIP;</span>
<span class="fc" id="L129">    }</span>
	
    /**
     * get the client IP address
     * @return clientIP the IP address of the client
     */
    public String getClientIP(){
<span class="fc" id="L136">	return clientIP;</span>
    }

    /**
     * get the sound status
     * @return soundOn whether the client's sound is on
     */
    public boolean isSoundOn(){
<span class="nc" id="L144">	return soundOn;</span>
    }

    /**
     * set the sound status
     * @param soundOn set the client's sound status
     */
    public void setSound(boolean soundOn){
<span class="nc" id="L152">	this.soundOn = soundOn;</span>
<span class="nc" id="L153">    }</span>
    
    /**
     * ConnectServer method takes server IP address parameter to connect the specific
     * server and takes client userName and password in order to check login authority 
     * @param IP Server IP address
     * @param userName userName
     * @param password user's password associate with the useruserName
     * @return boolean true when useruserName and password are valid, otherwise false
     */	
		
    public int connectServer(String IP, String userName, String password){
	//save the userName and IP address of client
<span class="fc" id="L166">	this.setUserName(userName);</span>
<span class="fc" id="L167">	this.setServerIP(IP);</span>
<span class="fc" id="L168">	controller = ClientController.getController();</span>
	try {
	    //create a new socket and connect to IP address at socket 8888
	    //get the input and output stream wrapped with DataOutput/InputStream
<span class="nc" id="L172">	    mySocket = new Socket(serverIP, portNumber);</span>
<span class="nc" id="L173">	    dos = new DataOutputStream(mySocket.getOutputStream());</span>
<span class="nc" id="L174">	    dis = new DataInputStream(mySocket.getInputStream());</span>
			
<span class="nc" id="L176">	    int result = checkAuthority(userName + &quot;&amp;&quot; + password);</span>
	    //check login authority
<span class="nc bnc" id="L178" title="All 2 branches missed.">	    if(result == 0){</span>
<span class="nc" id="L179">		controller.displayMsg(userName + &quot;(you) has connected to the server at &quot; + serverIP + '\n');</span>
<span class="nc" id="L180">		isConnected = true;</span>
<span class="nc" id="L181">		new Thread(new RecieveMsg()).start();</span>
		//if valid useruserName and password, return 1
<span class="nc" id="L183">		return 0;</span>
	    }
	    //if useruserName or password wrong
<span class="nc bnc" id="L186" title="All 2 branches missed.">	    else if(result == 1){</span>
<span class="nc" id="L187">		return 1;</span>
	    }
	    //if user logged in already
<span class="nc bnc" id="L190" title="All 2 branches missed.">	    else if(result == 2)</span>
<span class="nc" id="L191">		return 2;</span>
	    //if server is down
	    else
<span class="nc" id="L194">		return 9;</span>
<span class="fc" id="L195">	} catch (IOException e) {</span>
	    //if IP address not valid
<span class="fc" id="L197">	    return 8;</span>
	}
    }
	
    /**
     * disconnectServer method is used for disconnecting the client with the server
     */
    public void disconnectServer(){
		
<span class="nc" id="L206">    }</span>
	
    /**
     * checkAuthority method is used for checking if the useruserName and password are valid
     * @param s the combination of useruserName and password
     * @return boolean true when the server returns null, otherwise false
     */

		
    public int checkAuthority(String s){
<span class="nc" id="L216">	String result = &quot;&quot;;</span>
	try {
	    //write userName and password to the server and read result from the server
<span class="nc" id="L219">	    this.sendMsg(s);</span>
			
	    //get the contact list from the server and update the contact list of client window
<span class="nc" id="L222">	    result = dis.readUTF();</span>
<span class="nc" id="L223">	    String[] temp = parseReceivingMsg(result);</span>
			
<span class="nc bnc" id="L225" title="All 2 branches missed.">	    if(result.equals(&quot;Wrong username or password&quot;)){			</span>
<span class="nc" id="L226">		return 1;</span>
	    }		
<span class="nc bnc" id="L228" title="All 2 branches missed.">	    else if(result.equals(&quot;This user has logged in already&quot;)){</span>
<span class="nc" id="L229">		return 2;</span>
	    }
<span class="nc bnc" id="L231" title="All 2 branches missed.">	    else if (result.equals(&quot;No name was entered&quot;)){</span>
<span class="nc" id="L232">		return 3;</span>
	    }
	    else{
<span class="nc" id="L235">		String [] contactList = parseContactList(temp[0]);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">		for(int i=0; i&lt;contactList.length; i++){</span>
<span class="nc" id="L237">			controller.addContact(contactList[i]);</span>
		}
<span class="nc" id="L239">		return 0;</span>
	    }
				
<span class="nc" id="L242">	} catch (IOException e) {</span>
<span class="nc" id="L243">	    controller.displayMsg(&quot;Error occured when sending message to the server\n&quot;);</span>
<span class="nc" id="L244">	    return 9;</span>
	}
    }
	
    /**
     * Parse the contact list
     * @param s a contact list represented by a string (eg. &quot;Peng Wang:Andro Stotts&quot;)
     * @return array of strings that has contact userNames seperated
     */
    public String[] parseContactList(String s){	
<span class="fc" id="L254">	String[] temp = s.split(&quot;:&quot;);</span>
<span class="fc" id="L255">	String[] temp2 = new String[temp.length+1];</span>
	//add the broadcast to all option to the contact list
<span class="fc" id="L257">	temp2[0] = &quot;Broadcast&quot;;</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">	for(int i = 1; i &lt; temp.length+1; i++)</span>
<span class="fc" id="L259">	    temp2[i] = temp[i-1];</span>
<span class="fc" id="L260">	return temp2;</span>
    }
	
    /**
     * Parse the receiving message from the server
     * @param s received message
     * @return array of strings
     */
    public String[] parseReceivingMsg(String s){
<span class="fc" id="L269">	String[] temp = null;</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">	if(s.contains(&quot;&amp;&quot;)){</span>
<span class="fc" id="L271">	    int index = s.lastIndexOf(&quot;&amp;&quot;);</span>
<span class="fc" id="L272">	    String msg = s.substring(0, index);</span>
<span class="fc" id="L273">	    String c = s.substring(index+1, s.length());</span>
<span class="fc" id="L274">	    String[] str = {msg, c};</span>
<span class="fc" id="L275">	    temp = str;</span>
	}
<span class="fc" id="L277">	return temp;</span>
    }

    /**
     * sendMsg is the method that used for send a text message to the server
     * @param s text message
     */
    public void sendMsg(String s){
	try {
<span class="nc" id="L286">	    dos.writeUTF(s);</span>
<span class="nc" id="L287">	} catch (IOException e) {</span>
<span class="nc" id="L288">	    controller.displayMsg(&quot;Error occured when sending message to the server\n&quot;);</span>
<span class="nc" id="L289">	}</span>
<span class="nc" id="L290">    }</span>

	/**Method used to send a message to a single User. This is the preferred method to use when sending a single message to another User
	*Appends nickName to the front of the message to adhere to the server's message parsing requirements
	*@param msg String that contains the message to be sent as well as the relevant server information (See ClientController.sendIM())
	*@author jleeong
	*@version F16
	*/
	public void sendIM(String msg){
		try {
<span class="nc" id="L300">			dos.writeUTF(nickName+msg);</span>
<span class="nc" id="L301">	 	} catch (IOException e) {</span>
<span class="nc" id="L302">	    		controller.displayMsg(&quot;Error occured when sending message to the server\n&quot;);</span>
<span class="nc" id="L303">		}</span>
<span class="nc" id="L304">    	}</span>
    /**
     * RecieveMsg class represent a seperate thread that constantly recieving message from the server
     * @author Peng Wang and Andro Stotts
     * @version 0.4
     */
<span class="nc" id="L310">    class RecieveMsg implements Runnable{</span>
	public void run() {
	    try{
<span class="nc bnc" id="L313" title="All 2 branches missed.">		while(isConnected){</span>
<span class="nc" id="L314">		    String msg = dis.readUTF();</span>
<span class="nc" id="L315">		    String[] strs = parseReceivingMsg(msg);</span>
		    //Client has received a single number. This is ChatRoom registration.
<span class="nc bnc" id="L317" title="All 2 branches missed.">		    if(strs[1].equals(&quot;1009&quot;)){</span>
<span class="nc" id="L318">			controller.displayMsg(&quot;Registered in ChatRoom\n&quot;);</span>
<span class="nc" id="L319">			String roomnum=strs[0]; </span>
<span class="nc" id="L320">			String newc = &quot;ChatRoom:&quot;+roomnum;</span>
<span class="nc" id="L321">			controller.addContact(newc);</span>
<span class="nc" id="L322">		    }</span>
		    //client go online
<span class="nc bnc" id="L324" title="All 2 branches missed.">		    else if(strs[1].equals(&quot;1002&quot;)){</span>
<span class="nc" id="L325">			Contact arrival = new Contact(strs[0]);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if(contacts.contains(arrival)){</span>
<span class="nc" id="L327">				controller.updateContact(strs[0], true);</span>
			}
<span class="nc bnc" id="L329" title="All 2 branches missed.">			if(soundOn)</span>
			    {
<span class="nc" id="L331">				AePlayWave onlineSound = new AePlayWave(&quot;OhYeah.aiff&quot;);</span>
<span class="nc" id="L332">				onlineSound.start();</span>
			    }
<span class="nc" id="L334">		    }</span>
		    //client go offline
<span class="nc bnc" id="L336" title="All 2 branches missed.">		    else if(strs[1].equals(&quot;1003&quot;)){</span>
<span class="nc" id="L337">			Contact departed = new Contact(strs[0]);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">			if(contacts.contains(departed)){</span>
<span class="nc" id="L339">				controller.updateContact(strs[0], false);</span>
			}
<span class="nc bnc" id="L341" title="All 2 branches missed.">			if(soundOn){</span>
<span class="nc" id="L342">				AePlayWave offlineSound = new AePlayWave(&quot;HitWallObs.aiff&quot;);</span>
<span class="nc" id="L343">				offlineSound.start();</span>
			}
<span class="nc" id="L345">		    }</span>
		    //update the contact's nickname
<span class="nc bnc" id="L347" title="All 2 branches missed.">		    else if(strs[1].equals(&quot;1006&quot;)){</span>
		    //STUB
		    }
<span class="nc bnc" id="L350" title="All 2 branches missed.">		    else if(strs[1].equals(&quot;1007&quot;)){</span>
<span class="nc" id="L351">			controller.setNickname(strs[0]);</span>
		    }
<span class="nc bnc" id="L353" title="All 2 branches missed.">		    else if(strs[1].equals(&quot;1001&quot;)){</span>
			// display the incoming message
			//	JTextArea newMsg = new JJextArea(strs[0]);]
			//	newMsg.serForeground(Color.RED);
<span class="nc" id="L357">			controller.displayMsg(strs[0]+ '\n');</span>
		
			//play a sound
<span class="nc bnc" id="L360" title="All 2 branches missed.">			if(soundOn)</span>
			    {
<span class="nc" id="L362">				AePlayWave msgSound = new AePlayWave(&quot;Glass.aiff&quot;);</span>
<span class="nc" id="L363">				msgSound.start();</span>
			    }
		    }
<span class="nc" id="L366">		}</span>
<span class="nc" id="L367">	    } catch (SocketException e){</span>
<span class="nc" id="L368">		controller.displayMsg(&quot;The server has shutdown\n&quot;);</span>
<span class="nc" id="L369">	    } catch(IOException e){</span>
<span class="nc" id="L370">		controller.displayMsg(&quot;You have been kicked from the server.\n&quot;);</span>
<span class="nc" id="L371">	    }</span>
<span class="nc" id="L372">	}		</span>
    }

	/**Method to add a Contact to ArrayList&lt;Contact&gt; contacts.
	*@param nn a String representing the nickname of the contact to be added.
	*@author jleeong
	*@version F16
	*/
	public void addContact(Contact newc){
<span class="nc bnc" id="L381" title="All 2 branches missed.">		if(!contacts.contains(newc))</span>
<span class="nc" id="L382">			contacts.add(newc);</span>
<span class="nc" id="L383">	}</span>
	
	/**Method to modify online status of a Contact.
	*@param contact The nickname of the contact to modify
	*@param status A boolean representing online status.
	*@author jleeong
	*@version F16
	*/
	public void updateContact(String contact, boolean status){
<span class="nc" id="L392">		Contact mod = new Contact(contact);</span>
<span class="nc" id="L393">		contacts.get(contacts.indexOf(mod)).setOnline(status);</span>
<span class="nc" id="L394">	}</span>
	
	/**Method to send a ChatRoom registration request to the Server. Sends the registration message to the server.
	* @param reg a String constructed from the ClientController for proper message structure.
	* @author jleeong
	* @version F16
	*/
	public void sendChatRoomRegistration(String reg){
<span class="nc" id="L402">		sendMsg(reg);</span>
<span class="nc" id="L403">	}	</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>